---
title: Analytics
description: Architecture of the analytics pipeline with Tinybird
---

# Analytics Architecture

Clamo uses Tinybird as its analytics engine, providing real-time aggregations and insights across 200+ tenant databases consolidated into a single analytics layer.

## Architecture Overview

```mermaid
flowchart TB
    subgraph Sources [Data Sources]
        Sync[clamo-sync<br/>Rust CDC]
        Ingest[clamo-ingest-go<br/>Kafka Events]
        Upload[Direct Upload<br/>NDJSON/CSV]
    end
    
    subgraph Tinybird [Tinybird Platform]
        subgraph DS [Datasources]
            Raw[Raw Tables<br/>legal_cases, movements<br/>parties, decisions]
            Kafka[Kafka Tables<br/>cases_analytics<br/>movements_analytics]
            Static[Static Data<br/>generales_mibanco<br/>padron_ruc]
        end
        
        subgraph MV [Materializations]
            Consolidated[cases_consolidated_mv]
        end
        
        subgraph API [Endpoints]
            Stats[api_cases_stats]
            Trends[api_cases_trends]
            Dist[api_cases_distribution]
            Search[api_expedientes<br/>api_buscar]
        end
    end
    
    subgraph Consumers [Consumers]
        Clamy[Clamy Assistant<br/>MCP Integration]
        Luna[Luna Assistant<br/>Safe Tools]
        Dashboards[clamo-dashboards<br/>Rust API]
    end
    
    Sync -->|HTTP Events| Raw
    Ingest -->|Kafka| Kafka
    Upload --> Static
    
    Raw --> Consolidated
    Kafka --> Consolidated
    
    Consolidated --> Stats
    Consolidated --> Trends
    Consolidated --> Dist
    Raw --> Search
    
    Stats --> Clamy
    Stats --> Luna
    Stats --> Dashboards
```

## Data Flow

### clamo-sync (Rust)

The primary data synchronization service that consolidates 200+ Neon PostgreSQL databases into Tinybird.

**Key Features**:
- **Incremental sync** using `updated_at` watermarks
- **Schema detection** with automatic full sync on changes
- **Delete detection** via reconciliation (configurable interval)
- **Rate limiting** with exponential backoff for Tinybird limits
- **Horizontal scaling** with configurable worker concurrency

**Sync Flow**:
```mermaid
sequenceDiagram
    participant Supabase as Supabase Vault
    participant Sync as clamo-sync
    participant Neon as Neon DBs
    participant TB as Tinybird
    
    Sync->>Supabase: Get connection strings
    Supabase-->>Sync: Decrypted secrets
    
    loop For each tenant
        Sync->>Neon: Query changes since watermark
        Neon-->>Sync: Changed records
        Sync->>TB: POST /events
        TB-->>Sync: Ack
        Sync->>Sync: Update watermark
    end
```

### clamo-ingest-go (Kafka)

Streams real-time events from the ingestion pipeline directly to Tinybird via Kafka.

**Tables**:
- `cases_analytics` - Real-time case events
- `movements_analytics` - Movement notifications
- `milestones_analytics` - Milestone achievements

## Tinybird Configuration

The Tinybird configuration lives in the `clamo-clickhouse` repository.

### Datasources

| Datasource | Source | Description |
|------------|--------|-------------|
| `legal_cases` | clamo-sync | Core case data |
| `movements` | clamo-sync | Case movements/actions |
| `parties` | clamo-sync | Case parties (demandante/demandado) |
| `decisions` | clamo-sync | Court decisions |
| `case_states` | clamo-sync | Current state snapshots |
| `cases_analytics` | Kafka | Real-time case events |
| `movements_analytics` | Kafka | Real-time movement events |
| `cases_sync_consolidated` | ETL | Rust ETL output |
| `generales_mibanco` | Static | Reference data |
| `padron_ruc` | Static | RUC validation data |

### Materializations

**`cases_consolidated_mv`** - Pre-computed view that denormalizes case data with:
- Latest state
- Party information
- Movement counts
- Risk calculations
- Stage progress

### API Endpoints

| Endpoint | Description |
|----------|-------------|
| `api_cases_consolidated` | Full consolidated case list |
| `api_case_detail` | Single case with all relations |
| `api_cases_stats` | Aggregated KPIs |
| `api_cases_distribution` | Distribution by dimension |
| `api_cases_trends` | Time-series trends |
| `api_expedientes` | Filtered case listing |
| `api_buscar` | Full-text search |
| `api_estadisticas` | Global statistics |
| `api_analisis_juez` | Judge performance analysis |
| `api_analisis_tipologia` | Case type success rates |

## MCP Integration

Clamy and Luna access Tinybird through the MCP (Model Context Protocol) server.

```mermaid
flowchart LR
    subgraph Assistant [AI Assistant]
        Clamy[Clamy]
        Luna[Luna]
    end
    
    subgraph MCP [MCP Server]
        Server[Tinybird MCP]
        Tools[Tool Definitions]
    end
    
    subgraph TB [Tinybird]
        Endpoints[API Endpoints]
    end
    
    Clamy -->|All Tools| Server
    Luna -->|Safe Tools Only| Server
    Server --> Tools
    Tools --> Endpoints
```

**Luna Safe Tools** (whitelisted for global assistant):
- `api_estadisticas` - Global KPIs
- `api_por_zona` - Geographic distribution
- `api_expedientes` - Filtered listing
- `api_buscar` - Text search
- `api_estados_caso` - Status distribution
- `api_casos_atencion` - Critical cases
- `api_cases_trends` - Temporal trends
- `api_cases_distribution` - Dimensional distribution

**Luna Blocked Tools** (can generate errors):
- `text_to_sql` - Custom SQL generation
- `execute_query` - Custom SQL execution
- `explore_data` - Problematic queries

## clamo-dashboards Integration

The Rust-based dashboard service queries Tinybird for widget data:

```mermaid
flowchart LR
    WebApp[clamo-web-app] -->|API| Dashboards[clamo-dashboards<br/>Rust/Axum]
    Dashboards -->|HTTP| Tinybird[Tinybird<br/>Endpoints]
    Tinybird -->|JSON| Dashboards
    Dashboards -->|Widgets| WebApp
```

**Dashboard Features**:
- Customizable widget layouts
- Cached query results
- Multi-tenant isolation
- Real-time updates

## Observability

### clamo-sync Metrics

Prometheus metrics exposed at `/metrics`:
- `sync_records_total` - Records synced per tenant
- `sync_duration_seconds` - Sync duration histogram
- `sync_errors_total` - Error counts by type
- `tinybird_rate_limit_hits` - Rate limit encounters

### Alerting

Alertmanager integration sends notifications via clamo-mailing:
- Sync failures
- Rate limit warnings
- Schema change detections
- Reconciliation mismatches

## Project Structure

```
clamo-clickhouse/
├── connections/
│   └── kafka_analytics.connection    # Kafka connection config
├── datasources/
│   ├── legal_cases.datasource
│   ├── movements.datasource
│   ├── parties.datasource
│   ├── decisions.datasource
│   ├── case_states.datasource
│   ├── cases_analytics.datasource    # Kafka
│   └── ...
├── endpoints/
│   ├── api_cases_consolidated.pipe
│   ├── api_cases_stats.pipe
│   ├── api_cases_trends.pipe
│   └── ...
├── materializations/
│   └── cases_consolidated.pipe
└── fixtures/
    └── generales_mibanco.ndjson      # Test data
```

## Related Documentation

- [clamo-sync Service](/en/services/clamo-sync)
- [clamo-dashboards Service](/en/services/clamo-dashboards)
- [AI Assistants Architecture](/en/architecture/ai-assistants)
