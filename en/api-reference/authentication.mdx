---
title: Authentication
description: Authentication and authorization flow with WorkOS AuthKit
---

# Authentication

Clamo uses **WorkOS AuthKit** for authentication and authorization. This document explains how to obtain and use tokens to access the APIs.

## Authentication Flow

```mermaid
sequenceDiagram
    participant User
    participant App as Your Application
    participant WorkOS
    participant Clamo as Clamo API

    User->>App: Click "Sign In"
    App->>WorkOS: Redirect to AuthKit
    WorkOS->>User: Login screen
    User->>WorkOS: Credentials
    WorkOS->>App: Callback with code
    App->>WorkOS: Exchange code for tokens
    WorkOS-->>App: access_token + user_info
    App->>App: Create Clamo session
    App->>Clamo: Request with tokens
    Clamo-->>App: Data
```

## Required Tokens

To authenticate with Clamo APIs you need two tokens:

| Token | Header | Description |
|-------|--------|-------------|
| Access Token | `Authorization: Bearer <token>` | WorkOS JWT token |
| Session Token | `x-clamo-session: <token>` | Clamo session in base64 |

## Obtain Access Token

### With Next.js (AuthKit)

```typescript
import { getSession } from '@workos-inc/authkit-nextjs';

export async function GET(request: Request) {
  const session = await getSession();
  
  if (!session) {
    return Response.json({ error: 'Not authenticated' }, { status: 401 });
  }
  
  const { accessToken, user, organizationId } = session;
  
  // Use accessToken to call Clamo
}
```

### With the WorkOS SDK

```typescript
import WorkOS from '@workos-inc/node';

const workos = new WorkOS(process.env.WORKOS_API_KEY);

// After OAuth callback
const { accessToken, refreshToken, user } = await workos.userManagement.authenticateWithCode({
  clientId: process.env.WORKOS_CLIENT_ID,
  code: authCode,
});
```

## Create Session Token

The session token is a JSON object encoded in base64 containing user information:

```typescript
interface ClamoSession {
  userId: string;           // Clamo user ID
  workosUserId: string;     // WorkOS user ID
  organizationId: string;   // WorkOS organization ID
  companyId: string;        // Clamo company ID
  email: string;
  role: 'admin' | 'member';
}

function createSessionToken(session: ClamoSession): string {
  const json = JSON.stringify(session);
  return Buffer.from(json).toString('base64url');
}
```

### Complete Example

```typescript
// After authenticating with WorkOS
const workosSession = await getSession();

// Get additional information from Clamo
const meResponse = await fetch('https://api.clamo.dev/v1/me', {
  headers: {
    'Authorization': `Bearer ${workosSession.accessToken}`,
  },
});
const clamoUser = await meResponse.json();

// Create session token
const sessionData = {
  userId: clamoUser.id,
  workosUserId: workosSession.user.id,
  organizationId: workosSession.organizationId,
  companyId: clamoUser.companyId,
  email: clamoUser.email,
  role: clamoUser.role,
};

const sessionToken = Buffer.from(JSON.stringify(sessionData)).toString('base64url');

// Now you can use both tokens
const response = await fetch('https://api.clamo.dev/v1/cases', {
  headers: {
    'Authorization': `Bearer ${workosSession.accessToken}`,
    'x-clamo-session': sessionToken,
  },
});
```

## Authenticated Request Example

<CodeGroup>

```javascript JavaScript
const accessToken = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...';
const sessionToken = 'eyJ1c2VySWQiOiJ1c3JfYWJjMTIzIiwiY29tcGFueUlkIjoiY21wX3h5ejc4OSJ9';

const response = await fetch('https://api.clamo.dev/v1/cases', {
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'x-clamo-session': sessionToken,
  },
});

const data = await response.json();
```

```python Python
import httpx
import base64
import json

access_token = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."

session_data = {
    "userId": "usr_abc123",
    "companyId": "cmp_xyz789",
    "email": "user@empresa.com",
    "role": "admin"
}
session_token = base64.urlsafe_b64encode(
    json.dumps(session_data).encode()
).decode()

response = httpx.get(
    "https://api.clamo.dev/v1/cases",
    headers={
        "Authorization": f"Bearer {access_token}",
        "x-clamo-session": session_token,
    }
)
```

```bash cURL
curl -X GET https://api.clamo.dev/v1/cases \
  -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "x-clamo-session: eyJ1c2VySWQiOiJ1c3JfYWJjMTIzIn0"
```

</CodeGroup>

## Refresh Tokens

WorkOS access tokens expire after some time. Use the refresh token to get a new one:

```typescript
import WorkOS from '@workos-inc/node';

const workos = new WorkOS(process.env.WORKOS_API_KEY);

const { accessToken, refreshToken } = await workos.userManagement.authenticateWithRefreshToken({
  clientId: process.env.WORKOS_CLIENT_ID,
  refreshToken: storedRefreshToken,
});
```

## Roles and Permissions

Clamo defines two main roles:

| Role | Description | Permissions |
|------|-------------|-------------|
| `admin` | Company administrator | Full CRUD, invite users, configuration |
| `member` | Member | Read cases, comments |

### Check Permissions

```typescript
// Role comes in the session token
const session = JSON.parse(
  Buffer.from(sessionToken, 'base64url').toString()
);

if (session.role !== 'admin') {
  throw new Error('Administrator permissions required');
}
```

## Authentication Errors

| Code | Error | Cause |
|------|-------|-------|
| 401 | `UNAUTHORIZED` | Missing or invalid token |
| 401 | `TOKEN_EXPIRED` | Expired access token |
| 401 | `INVALID_SESSION` | Malformed session token |
| 403 | `FORBIDDEN` | No permissions for resource |
| 403 | `ORGANIZATION_MISMATCH` | Token from another organization |

### Error Example

```json
{
  "error": {
    "code": "TOKEN_EXPIRED",
    "message": "The access token has expired. Please renew your session.",
    "details": {
      "expiredAt": "2025-01-02T10:00:00Z"
    }
  }
}
```

## WorkOS Configuration

To integrate WorkOS in your application:

1. Create an account at [WorkOS](https://workos.com)
2. Configure AuthKit with your domain
3. Get the credentials:

```bash
WORKOS_API_KEY=sk_live_...
WORKOS_CLIENT_ID=client_...
```

4. Configure the callback URL in the WorkOS dashboard

## Security

<Warning>
**Never expose tokens in the frontend**

Access tokens and refresh tokens must only be handled in the backend. Use HttpOnly cookies to store sessions in the browser.
</Warning>

### Best Practices

- Always use HTTPS
- Store refresh tokens securely (encrypted at rest)
- Implement logout that invalidates tokens
- Rotate refresh tokens periodically
- Validate the `organizationId` on each request

## Next Steps

<CardGroup cols={2}>
  <Card
    title="Errors"
    icon="triangle-exclamation"
    href="/en/api-reference/errors"
  >
    Error handling and response codes.
  </Card>
  <Card
    title="Authentication Guide"
    icon="book"
    href="/en/guides/authentication"
  >
    Complete WorkOS integration guide.
  </Card>
</CardGroup>
