---
title: clamo-database
description: Prisma schemas, migrations, and multi-tenant connection management
---

Shared package containing Prisma schemas, migrations, and utilities for multi-tenant connection management.

## General Information

| Property | Value |
|----------|-------|
| **Repository** | `GetClamo/clamo-database` |
| **Language** | TypeScript |
| **ORM** | Prisma |
| **Package** | `@getclamo/database` |
| **Databases** | Supabase (Control) + Neon (Tenants) |

## Architecture

```mermaid
flowchart TB
    subgraph Package [@getclamo/database]
        ControlSchema[Control Schema]
        TenantSchema[Tenant Schema]
        ClientFactory[Client Factory]
        LRUCache[LRU Cache]
    end

    subgraph Databases [Databases]
        Supabase[(Supabase<br/>Control Plane)]
        Neon1[(Neon Tenant 1)]
        Neon2[(Neon Tenant 2)]
        NeonN[(Neon Tenant N)]
    end

    ControlSchema --> Supabase
    TenantSchema --> Neon1
    TenantSchema --> Neon2
    TenantSchema --> NeonN

    ClientFactory --> LRUCache
    LRUCache --> Neon1
    LRUCache --> Neon2
    LRUCache --> NeonN
```

## Control Plane Schema

```mermaid
erDiagram
    Company ||--o{ User : has
    Company ||--o| CompanyDatabase : has
    Company ||--o{ Company : parent

    Company {
        uuid id PK
        string workosOrgId UK
        string name
        string ruc
        uuid parentId FK
        string plan
        enum databaseStatus
        string billingEmail
        json settings
        json features
    }

    CompanyDatabase {
        uuid id PK
        uuid companyId FK,UK
        string neonProjectId
        string neonBranchId
        string databaseName
        string databaseHost
        string pooledConnSecretId
        string directConnSecretId
    }

    User {
        uuid id PK
        string workosUserId UK
        string email UK
        string firstName
        string lastName
        uuid companyId FK
        string role
        enum onboardingState
    }

    Stage ||--o{ SubStage : has
    SubStage ||--o{ Milestone : has

    Stage {
        string code PK
        string name
        int sortOrder
        boolean isDecision
    }

    SubStage {
        string stageCode PK,FK
        string code PK
        string name
        int sortOrder
    }

    Milestone {
        string stageCode PK,FK
        string subStageCode PK,FK
        string code PK
        string label
        boolean isDecision
    }
```

## Tenant Schema

```mermaid
erDiagram
    Case ||--o{ Party : has
    Case ||--o{ CaseClaim : has
    Case ||--o{ Movement : has
    Case ||--o{ Decision : has
    Case ||--|| CaseState : has
    Case ||--o{ CaseIngestRun : has

    Case {
        uuid id PK
        string companyId
        string caseNumber
        datetime filingDate
        json subjectMatter
        json processType
        json stage
        string court
        string judge
    }

    Party {
        uuid id PK
        uuid caseId FK
        string name
        enum type
        enum role
    }

    CaseClaim {
        uuid id PK
        uuid caseId FK
        enum claimType
        decimal amount
        string currency
        enum source
    }

    Movement ||--o{ MovementAttachment : has
    Movement ||--o{ MovementNotification : has
    Movement ||--o| Decision : has

    Movement {
        uuid id PK
        uuid caseId FK
        int stablePosition
        datetime cejEventDate
        string cejActo
        string cejResolution
        json name
        json summary
        string stageCode
        string subStageCode
        string milestoneCode
    }

    MovementAttachment {
        uuid id PK
        uuid movementId FK
        string cejNid UK
        string kind
        string url
        enum state
    }

    MovementNotification {
        uuid id PK
        uuid movementId FK
        string destinatario
        datetime fechaEnvio
        string formaEntrega
    }

    Decision {
        uuid id PK
        uuid caseId FK
        uuid movementId FK,UK
        enum scope
        datetime decidedAt
        enum instanceResult
        enum defendantOutcome
        decimal amountPrincipal
    }

    CaseState {
        uuid caseId PK,FK
        uuid lastMovementId
        string currentStageCode
        boolean isArchived
        enum archiveType
        enum finalStatus
        enum defendantOutcome
    }

    CaseIngestRun {
        uuid id PK
        uuid caseId FK
        string expediente
        string manifestHash
        enum status
    }

    Dashboard {
        uuid id PK
        string companyId
        string name
        json config
        boolean isDefault
    }
```

## Usage

```typescript
import { controlDb, createTenantPrisma } from "@getclamo/database";

// Control plane client (singleton)
const companies = await controlDb.company.findMany();

// Tenant client (cached by connection)
const tenantDb = createTenantPrisma(connectionString);
const cases = await tenantDb.case.findMany();
```

## Configuration

### Environment Variables

```bash
# Control database
CONTROL_DATABASE_URL=postgresql://...

# Supabase (for Vault)
SUPABASE_URL=https://...
SUPABASE_SERVICE_KEY=...

# For local development with specific tenant
TENANT_DATABASE_URL=postgresql://...
```

## Local Development

```bash
# Install dependencies
pnpm install

# Generate Prisma clients
pnpm db:generate

# Run control migrations
pnpm migrate:control

# Run tenant migrations (all tenants)
pnpm migrate:tenants

# Build package
pnpm build
```

## Next Steps

<CardGroup cols={2}>
  <Card
    title="Entities"
    icon="database"
    href="/en/entities/index"
  >
    Complete entity reference.
  </Card>
  <Card
    title="Multi-Tenancy"
    icon="building"
    href="/en/guides/multi-tenancy"
  >
    Multi-tenant architecture.
  </Card>
</CardGroup>
