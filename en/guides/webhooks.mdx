---
title: Webhooks
description: Receive real-time notifications of events in Clamo
---

# Webhooks

Webhooks allow your application to receive notifications when important events occur in Clamo.

## Available Events

| Event | Description |
|-------|-------------|
| `case.created` | New case detected |
| `case.updated` | Case updated |
| `case.status_changed` | Case status changed |
| `movement.created` | New procedural movement |
| `movement.notification` | Movement with notification |
| `milestone.achieved` | Procedural milestone achieved |
| `risk.elevated` | Risk level increased |

## Configuration

### Register Webhook

```bash
curl -X POST https://api.clamo.dev/v1/webhooks \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://your-app.com/webhooks/clamo",
    "events": ["case.created", "movement.created", "risk.elevated"],
    "secret": "whsec_your_secure_secret"
  }'
```

### Response

```json
{
  "id": "wh_abc123",
  "url": "https://your-app.com/webhooks/clamo",
  "events": ["case.created", "movement.created", "risk.elevated"],
  "status": "active",
  "createdAt": "2025-01-02T12:00:00Z"
}
```

## Payload Format

All webhooks follow this format:

```json
{
  "id": "evt_xyz789",
  "type": "movement.created",
  "timestamp": "2025-01-02T12:00:00Z",
  "data": {
    // Event-specific data
  },
  "metadata": {
    "companyId": "cmp_abc123",
    "webhookId": "wh_abc123"
  }
}
```

## Event Examples

### case.created

```json
{
  "id": "evt_001",
  "type": "case.created",
  "timestamp": "2025-01-02T12:00:00Z",
  "data": {
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01",
      "plaintiff": "Juan Pérez",
      "defendant": "Empresa S.A.C.",
      "subjectMatter": "Wrongful termination",
      "riskLevel": "MEDIUM",
      "status": "EN_TRAMITE",
      "filingDate": "2024-01-15"
    },
    "monitoredEntity": {
      "id": "ent_xyz",
      "ruc": "20123456789",
      "name": "Empresa S.A.C."
    }
  }
}
```

### movement.created

```json
{
  "id": "evt_002",
  "type": "movement.created",
  "timestamp": "2025-01-02T14:30:00Z",
  "data": {
    "movement": {
      "id": "mov_xyz789",
      "date": "2025-01-02",
      "description": "RESOLUTION N° 15: The answer to the complaint is accepted",
      "classification": "RESOLUCION",
      "isNotification": false,
      "summary": "The court admits the answer to the complaint filed by the company."
    },
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01"
    }
  }
}
```

### risk.elevated

```json
{
  "id": "evt_003",
  "type": "risk.elevated",
  "timestamp": "2025-01-02T16:00:00Z",
  "data": {
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01"
    },
    "previousRiskLevel": "MEDIUM",
    "newRiskLevel": "HIGH",
    "reason": "Unfavorable judgment in first instance",
    "triggerMovement": {
      "id": "mov_def456",
      "description": "JUDGMENT: The complaint is declared FOUNDED..."
    }
  }
}
```

### milestone.achieved

```json
{
  "id": "evt_004",
  "type": "milestone.achieved",
  "timestamp": "2025-01-02T10:00:00Z",
  "data": {
    "milestone": {
      "code": "SENTENCIA_PRIMERA_INSTANCIA",
      "name": "First Instance Judgment",
      "achievedAt": "2025-01-02T10:00:00Z"
    },
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01"
    }
  }
}
```

## Signature Verification

Clamo signs all webhooks with HMAC-SHA256. Verify the signature before processing:

### Signature Header

```
X-Clamo-Signature: sha256=abc123...
X-Clamo-Timestamp: 1704200000
```

### Verification in Node.js

```typescript
import crypto from 'crypto';

function verifyWebhookSignature(
  payload: string,
  signature: string,
  timestamp: string,
  secret: string
): boolean {
  // Verify timestamp is not too old (prevents replay attacks)
  const timestampMs = parseInt(timestamp) * 1000;
  const now = Date.now();
  if (now - timestampMs > 5 * 60 * 1000) { // 5 minutes
    return false;
  }
  
  // Calculate expected signature
  const signedPayload = `${timestamp}.${payload}`;
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(signedPayload)
    .digest('hex');
  
  // Secure comparison
  const providedSig = signature.replace('sha256=', '');
  return crypto.timingSafeEqual(
    Buffer.from(expectedSignature),
    Buffer.from(providedSig)
  );
}
```

### Verification in Python

```python
import hmac
import hashlib
import time

def verify_webhook_signature(
    payload: str,
    signature: str,
    timestamp: str,
    secret: str
) -> bool:
    # Verify timestamp
    timestamp_int = int(timestamp)
    now = int(time.time())
    if now - timestamp_int > 300:  # 5 minutes
        return False
    
    # Calculate expected signature
    signed_payload = f"{timestamp}.{payload}"
    expected_signature = hmac.new(
        secret.encode(),
        signed_payload.encode(),
        hashlib.sha256
    ).hexdigest()
    
    # Secure comparison
    provided_sig = signature.replace("sha256=", "")
    return hmac.compare_digest(expected_signature, provided_sig)
```

## Endpoint Implementation

### Next.js API Route

```typescript
// app/api/webhooks/clamo/route.ts
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';

const WEBHOOK_SECRET = process.env.CLAMO_WEBHOOK_SECRET!;

export async function POST(request: NextRequest) {
  const payload = await request.text();
  const signature = request.headers.get('X-Clamo-Signature')!;
  const timestamp = request.headers.get('X-Clamo-Timestamp')!;
  
  // Verify signature
  if (!verifyWebhookSignature(payload, signature, timestamp, WEBHOOK_SECRET)) {
    return NextResponse.json(
      { error: 'Invalid signature' },
      { status: 401 }
    );
  }
  
  const event = JSON.parse(payload);
  
  // Process event
  switch (event.type) {
    case 'case.created':
      await handleNewCase(event.data);
      break;
    case 'movement.created':
      await handleNewMovement(event.data);
      break;
    case 'risk.elevated':
      await handleRiskElevation(event.data);
      break;
    default:
      console.log(`Unhandled event type: ${event.type}`);
  }
  
  // Respond 200 to confirm receipt
  return NextResponse.json({ received: true });
}

async function handleNewCase(data: any) {
  // Notify the team
  await sendSlackNotification({
    channel: '#new-cases',
    text: `New case detected: ${data.case.expediente}`,
  });
}

async function handleNewMovement(data: any) {
  // Update dashboard
  await refreshDashboard(data.case.id);
}

async function handleRiskElevation(data: any) {
  // Urgent alert
  await sendUrgentAlert({
    case: data.case,
    newRisk: data.newRiskLevel,
    reason: data.reason,
  });
}
```

### Express.js

```typescript
import express from 'express';
import crypto from 'crypto';

const app = express();

// Important: use raw body to verify signature
app.post('/webhooks/clamo', 
  express.raw({ type: 'application/json' }),
  async (req, res) => {
    const payload = req.body.toString();
    const signature = req.headers['x-clamo-signature'] as string;
    const timestamp = req.headers['x-clamo-timestamp'] as string;
    
    if (!verifyWebhookSignature(payload, signature, timestamp, WEBHOOK_SECRET)) {
      return res.status(401).json({ error: 'Invalid signature' });
    }
    
    const event = JSON.parse(payload);
    
    // Process in background to respond quickly
    processWebhookAsync(event);
    
    res.json({ received: true });
  }
);
```

## Retries

Clamo retries failed webhooks with exponential backoff:

| Attempt | Delay |
|---------|-------|
| 1 | Immediate |
| 2 | 1 minute |
| 3 | 5 minutes |
| 4 | 30 minutes |
| 5 | 2 hours |

A webhook is considered failed if:
- It responds with code >= 400
- It doesn't respond within 30 seconds
- There's a connection error

## Webhook Management

### List Webhooks

```bash
curl -X GET https://api.clamo.dev/v1/webhooks \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION"
```

### Update Webhook

```bash
curl -X PATCH https://api.clamo.dev/v1/webhooks/wh_abc123 \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" \
  -H "Content-Type: application/json" \
  -d '{
    "events": ["case.created", "movement.created"],
    "status": "active"
  }'
```

### Delete Webhook

```bash
curl -X DELETE https://api.clamo.dev/v1/webhooks/wh_abc123 \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION"
```

### View Delivery History

```bash
curl -X GET https://api.clamo.dev/v1/webhooks/wh_abc123/deliveries \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION"
```

## Best Practices

<Warning>
**Idempotency**: Your endpoint must be idempotent. Clamo may send the same event more than once in case of retries. Use the event `id` to detect duplicates.
</Warning>

### Asynchronous Processing

```typescript
// Respond quickly and process in background
app.post('/webhooks/clamo', async (req, res) => {
  // Verify signature...
  
  // Queue for processing
  await queue.add('process-webhook', event);
  
  // Respond immediately
  res.json({ received: true });
});
```

### Logging

```typescript
async function processWebhook(event: WebhookEvent) {
  console.log(`Processing webhook: ${event.id} (${event.type})`);
  
  try {
    // Process...
    console.log(`Webhook processed successfully: ${event.id}`);
  } catch (error) {
    console.error(`Webhook processing failed: ${event.id}`, error);
    throw error; // To retry
  }
}
```

## Next Steps

<CardGroup cols={2}>
  <Card
    title="Errors"
    icon="triangle-exclamation"
    href="/en/guides/errors"
  >
    Common error handling.
  </Card>
  <Card
    title="Best Practices"
    icon="lightbulb"
    href="/en/guides/best-practices"
  >
    Integration recommendations.
  </Card>
</CardGroup>
