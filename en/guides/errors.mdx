---
title: Errors and Troubleshooting
description: Guide to Clamo architecture-specific errors and how to resolve them
---

# Errors and Troubleshooting

This guide documents errors specific to Clamo's architecture: **Multi-tenancy**, **Unified AI**, **Trusted Sources**, and **Internal Communication**. Learn to diagnose and resolve the most common problems.

## Multi-Tenancy Errors

### COMPANY_NOT_READY (422)

**Symptoms:**
- API returns 422 when trying to access data
- User just created their account

**Cause:** Company was created in Supabase but Neon is still provisioning the database branch (Cold Start of ~5-10 seconds).

```json
{
  "error": {
    "code": "COMPANY_NOT_READY",
    "message": "Company database is being configured",
    "details": {
      "databaseStatus": "provisioning"
    }
  }
}
```

**Solution:** Implement polling on the `databaseStatus` field:

```typescript
async function waitForCompanyReady(companyId: string): Promise<Company> {
  const maxAttempts = 12; // 60 seconds max
  const interval = 5000; // 5 seconds

  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    const company = await tenant.companies.get(companyId);

    switch (company.databaseStatus) {
      case "ready":
        return company;
      case "failed":
        throw new Error("Database provisioning failed");
      case "provisioning":
        await sleep(interval);
        continue;
    }
  }

  throw new Error("Timeout waiting for database");
}
```

**In Frontend:**

```tsx
function OnboardingStatus({ companyId }: { companyId: string }) {
  const { data: company, isLoading } = useQuery({
    queryKey: ["company", companyId],
    queryFn: () => tenant.companies.get(companyId),
    refetchInterval: (data) => 
      data?.databaseStatus === "provisioning" ? 5000 : false,
  });

  if (company?.databaseStatus === "provisioning") {
    return <Spinner message="Setting up your workspace..." />;
  }

  return <Dashboard />;
}
```

### Connection Timeout to Tenant DB

**Symptoms:**
- Sporadic timeouts on queries
- `ECONNREFUSED` or `Connection terminated` errors

**Cause:** Neon branch entered "sleep" mode due to inactivity (Neon suspends inactive branches).

**Solution:** Implement retry with backoff:

```typescript
async function queryWithRetry<T>(
  fn: () => Promise<T>,
  maxRetries = 3
): Promise<T> {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      if (isConnectionError(error) && attempt < maxRetries - 1) {
        // Neon cold start: wait and retry
        await sleep(Math.pow(2, attempt) * 1000);
        continue;
      }
      throw error;
    }
  }
  throw new Error("Max retries exceeded");
}

function isConnectionError(error: unknown): boolean {
  const message = error instanceof Error ? error.message : "";
  return (
    message.includes("ECONNREFUSED") ||
    message.includes("Connection terminated") ||
    message.includes("timeout")
  );
}
```

## AI Errors (Tool Guard)

### TOOL_NOT_ALLOWED

**Symptoms:**
- LLM says it "can't" do something it should be able to
- Tool exists but doesn't execute

**Cause:** You're talking to the wrong profile. Each profile (Javi, Clamy, Luna) has specific tools. Tool Guard middleware blocks non-permitted tools.

```
User: "Show me a chart of cases by month"
Javi: "Sorry, I don't have access to visualization tools"
       ← Javi is for cases, Clamy is for analytics
```

**Diagnosis:**

```typescript
// Check which profile is active
const config = runConfig.configurable;
console.log("Active profile:", config.assistant_name);
console.log("Requested tool:", toolCall.name);

// See allowed tools per profile
const PROFILE_TOOLS = {
  javi: ["get_case", "search_cases", "get_movements"],
  clamy: ["show_chart", "get_analytics", "compare_periods"],
  luna: ["*"], // Luna has access to everything
};
```

**Solution:** Switch profile based on intent:

```typescript
function detectIntentAndProfile(message: string): string {
  if (message.match(/chart|graph|analytics|statistics/i)) {
    return "clamy";
  }
  if (message.match(/case|file|movement|lawsuit/i)) {
    return "javi";
  }
  return "luna"; // Default for general questions
}

// In frontend
const profile = detectIntentAndProfile(userMessage);
await invokeGraph({
  config: {
    configurable: {
      assistant_name: profile,
    },
  },
});
```

### LLM Hallucinating Tools

**Symptoms:**
- LLM tries to call tools that don't exist
- `Tool 'xyz' not found` errors

**Cause:** LLM doesn't have the updated list of available tools.

**Solution:** Ensure system prompt includes tools:

```typescript
// luna/src/prompts/javi.py
JAVI_SYSTEM_PROMPT = """
You are Javi, Clamo's legal case assistant.

## Available Tools
You can ONLY use these tools:
- get_case(case_id): Get case details
- search_cases(query): Search cases
- get_movements(case_id): Get case movements

DO NOT try to use tools not in this list.
"""
```

## Internal Authentication Errors

### MISSING_AUTH_HEADERS

**Symptoms:**
- 401 error when calling from one microservice to another
- `x-workos-*` headers not present

**Cause:** Developer tried to call a public endpoint (`/v1/...`) from another microservice, bypassing Kong.

```typescript
// ❌ INCORRECT: Call public endpoint from backend
const response = await fetch(`${CASES_URL}/v1/cases/${caseId}`);
// Error: No x-workos-* headers because it didn't go through Kong
```

**Solution:** Use internal endpoints for service-to-service:

```typescript
// ✅ CORRECT: Use internal endpoint
const response = await fetch(
  `${CASES_URL}/internal/v1/companies/${companyId}/cases/${caseId}`
);
// OK: Internal endpoints don't require auth (trusted network)
```

**Or use SDK:**

```typescript
// ✅ CORRECT: Use SDK
import Cases from "@getclamo/cases";

const cases = new Cases({ baseURL: env.CASES_SERVICE_URL });
const caseData = await cases.internal.companies(companyId).cases.get(caseId);
```

### ORGANIZATION_MISMATCH

**Symptoms:**
- 403 error when accessing resources
- User is authenticated but can't see data

**Cause:** JWT token has a different `org_id` than the company they're trying to access.

```json
{
  "error": {
    "code": "ORGANIZATION_MISMATCH",
    "message": "You don't have access to this organization",
    "details": {
      "tokenOrgId": "org_abc",
      "requestedOrgId": "org_xyz"
    }
  }
}
```

**Diagnosis:**

```typescript
// Check token org_id
const session = c.get("session");
console.log("Token org_id:", session.orgId);

// Check requested company
const company = await controlDb.company.findUnique({
  where: { id: requestedCompanyId },
});
console.log("Company workosOrgId:", company.workosOrgId);
```

**Solution:** User must switch organization in WorkOS:

```typescript
// Frontend: Org switcher
import { getSignInUrl } from "@workos-inc/authkit-nextjs";

async function switchOrganization(orgId: string) {
  const signInUrl = await getSignInUrl({
    organizationId: orgId,
  });
  window.location.href = signInUrl;
}
```

## Async Ingestion Errors

### Inconsistent Case State

**Symptoms:**
- Case exists but has no movements
- Partial or incomplete data

**Cause:** `CaseIngestRun` is in an intermediate state, not `COMPLETED`.

```typescript
// CaseIngestRun states
enum IngestRunStatus {
  RUNNING = "RUNNING",                    // Scraping in progress
  MOVEMENTS_COMPLETE = "MOVEMENTS_COMPLETE", // Movements extracted
  ANALYSIS_COMPLETE = "ANALYSIS_COMPLETE",   // AI processed
  COMPLETED = "COMPLETED",                // All done
  FAILED = "FAILED",                      // Error
}
```

**Diagnosis:**

```sql
-- Check ingest run status
SELECT 
  ir.id,
  ir.status,
  ir."startedAt",
  ir."completedAt",
  ir.error,
  c.expediente
FROM "CaseIngestRun" ir
JOIN "Case" c ON ir."caseId" = c.id
WHERE c.id = 'case_xyz'
ORDER BY ir."startedAt" DESC
LIMIT 1;
```

**Solution:** Don't treat data as final until `COMPLETED`:

```typescript
// In frontend
function CaseDetail({ caseId }: { caseId: string }) {
  const { data: caseData } = useQuery(["case", caseId], () => 
    cases.get(caseId)
  );
  
  const { data: ingestRun } = useQuery(["ingest-run", caseId], () =>
    cases.ingestRuns.getLatest(caseId)
  );

  if (ingestRun?.status !== "COMPLETED") {
    return (
      <Alert variant="info">
        <Spinner size="sm" />
        <span>
          {ingestRun?.status === "RUNNING" && "Extracting data from CEJ..."}
          {ingestRun?.status === "MOVEMENTS_COMPLETE" && "Analyzing with AI..."}
          {ingestRun?.status === "ANALYSIS_COMPLETE" && "Finalizing..."}
        </span>
      </Alert>
    );
  }

  return <CaseDetails case={caseData} />;
}
```

### INGEST_RUN_FAILED

**Symptoms:**
- Case didn't get updated
- Error in ingestion pipeline

**Cause:** Failure in some pipeline stage (scraping, normalization, insertion).

**Diagnosis:**

```typescript
// Get error details
const ingestRun = await cases.internal
  .companies(companyId)
  .ingestRuns.get(runId);

console.log("Status:", ingestRun.status);
console.log("Error:", ingestRun.error);
console.log("Failed at:", ingestRun.failedAt);

// Common errors:
// - "CEJ_TIMEOUT": CEJ didn't respond
// - "PARSE_ERROR": CEJ HTML changed
// - "LLM_ERROR": Anthropic failed
// - "DB_ERROR": Insert error
```

**Solution:** Retry ingestion:

```typescript
// Retry failed ingestion
await cases.internal.companies(companyId).ingestRuns.create({
  caseId: caseId,
  expediente: expediente,
  source: "MANUAL_RETRY",
});
```

## Trusted Source Errors

### Manual Value Overwritten

**Symptoms:**
- A user-corrected value was replaced
- User reports their "changes were lost"

**Cause:** A batch process (ingestion, sync) overwrote a `manual` value with an `ai` or `cej` value.

**Diagnosis:**

```sql
-- See field change history
SELECT 
  id,
  expediente,
  risk_level->>'cej' as cej_value,
  risk_level->>'ai' as ai_value,
  risk_level->>'manual' as manual_value,
  risk_level->'updatedAt'->>'manual' as manual_updated_at,
  "updatedAt"
FROM "Case"
WHERE id = 'case_xyz';
```

**Prevention:** Always verify before overwriting:

```typescript
// In ingestion service
async function updateCaseFromCEJ(caseId: string, cejData: CEJData) {
  const existing = await caseRepo.findById(tenantDb, caseId);

  const updateData: Partial<CaseData> = {};

  // Only update CEJ fields if no manual value exists
  for (const field of SOURCED_FIELDS) {
    const currentValue = existing[field] as SourcedValue;

    if (currentValue.manual === null) {
      updateData[field] = {
        ...currentValue,
        cej: cejData[field],
        updatedAt: {
          ...currentValue.updatedAt,
          cej: new Date().toISOString(),
        },
      };
    } else {
      console.log(`Skipping ${field} - manual value exists`);
    }
  }

  return caseRepo.update(tenantDb, caseId, updateData);
}
```

## Quick Reference Table

| Error | Code | Common Cause | Solution |
|-------|------|--------------|----------|
| `COMPANY_NOT_READY` | 422 | DB provisioning | Poll until `ready` |
| `TOOL_NOT_ALLOWED` | - | Wrong profile | Change `assistant_name` |
| `MISSING_AUTH_HEADERS` | 401 | Direct call without Kong | Use `/internal/...` |
| `ORGANIZATION_MISMATCH` | 403 | Token from another org | Switch organization |
| `INGEST_RUN_FAILED` | - | Pipeline failed | Retry ingestion |
| Connection Timeout | - | Neon cold start | Retry with backoff |

## Next Steps

<CardGroup cols={2}>
  <Card
    title="Best Practices"
    icon="lightbulb"
    href="/en/guides/best-practices"
  >
    Avoid these errors from the start.
  </Card>
  <Card
    title="Security"
    icon="shield"
    href="/en/architecture/security"
  >
    Understand the chain of trust.
  </Card>
  <Card
    title="Ingestion Debugging"
    icon="bug"
    href="/en/guides/debugging-ingestion"
  >
    Data pipeline troubleshooting.
  </Card>
  <Card
    title="API Reference"
    icon="code"
    href="/en/api-reference/errors"
  >
    API error codes.
  </Card>
</CardGroup>
