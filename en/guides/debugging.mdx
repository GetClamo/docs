---
title: Debugging
description: Troubleshooting and debugging guide for Clamo services
---

# Debugging Guide

This guide provides techniques and tools for debugging the different Clamo services.

## Logs by Service

### Log Locations

| Service | Location | Format |
|---------|----------|--------|
| clamo-web-app | Terminal / Browser Console | JSON |
| clamo-tenant | Terminal stdout | JSON |
| clamo-cases | Terminal stdout | JSON |
| clamo-cej-connector | Docker logs / Temporal UI | JSON |
| clamo-ingest-go | Docker logs | Structured |
| Temporal | http://localhost:8233 | Web UI |

### View Logs in Real Time

```bash
# TypeScript services (development)
cd clamo-tenant && pnpm dev

# Docker services
docker logs -f clamo-cej-connector

# All Docker services
docker-compose logs -f

# Filter by level
docker logs clamo-cej-connector 2>&1 | grep ERROR
```

## Database Debugging

### Prisma Studio

```bash
# Control database
cd clamo-database
npx prisma studio --schema=prisma/control/schema.prisma

# Tenant database (requires connection string)
DATABASE_URL="postgresql://..." npx prisma studio --schema=prisma/tenant/schema.prisma
```

### Direct Queries with psql

```bash
# Connect to control DB
psql $CONTROL_DATABASE_URL

# Useful queries
SELECT * FROM "Company" ORDER BY "createdAt" DESC LIMIT 10;
SELECT * FROM "User" WHERE "companyId" = 'cmp_xxx';
SELECT * FROM "CompanyDatabase" WHERE status = 'active';
```

### Verify Tenant Status

```sql
-- View all companies and their DB status
SELECT 
  c.id,
  c.name,
  c."databaseStatus",
  cd.status as db_status,
  cd."neonBranchId"
FROM "Company" c
LEFT JOIN "CompanyDatabase" cd ON c.id = cd."companyId"
ORDER BY c."createdAt" DESC;
```

## API Debugging

### Postman Collection

Import the Postman collection from:
```
clamo-commons/postman/Clamo-API.postman_collection.json
```

### cURL Examples

```bash
# Health check
curl http://localhost:4001/health | jq

# Get current user
curl http://localhost:4001/v1/me \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" | jq

# List cases
curl "http://localhost:4000/v1/cases?limit=5" \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" | jq
```

### Generate Session Token for Testing

```typescript
// scripts/generate-session.ts
import { encode } from 'base64url';

const session = {
  userId: 'usr_test123',
  workosUserId: 'user_workos123',
  organizationId: 'org_test456',
  companyId: 'cmp_test789',
  email: 'test@example.com',
  role: 'admin',
};

console.log(encode(JSON.stringify(session)));
```

## Temporal Workflow Debugging

### Temporal Web UI

Access http://localhost:8233 to:
- View running workflows
- Inspect event history
- Restart failed workflows
- View metrics

### Temporal CLI

```bash
# List workflows
temporal workflow list --namespace clamo-cej

# View workflow details
temporal workflow show --workflow-id extract-ruc-20123456789

# Terminate workflow
temporal workflow terminate --workflow-id extract-ruc-20123456789

# View history
temporal workflow show --workflow-id extract-ruc-20123456789 --output json | jq
```

## Kafka Debugging

### Kafka UI

If using Docker Compose, access http://localhost:8080 (Kafka UI).

### Kafka CLI

```bash
# List topics
kafka-topics.sh --bootstrap-server localhost:9092 --list

# Consume messages
kafka-console-consumer.sh \
  --bootstrap-server localhost:9092 \
  --topic cej.case.ready \
  --from-beginning

# View consumer group offsets
kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group clamo-ingest \
  --describe
```

## AI Agent Debugging

### LangSmith Integration

1. Configure environment variables:
```bash
LANGCHAIN_TRACING_V2=true
LANGCHAIN_API_KEY=ls__...
LANGCHAIN_PROJECT=clamo-dev
```

2. Access https://smith.langchain.com to view:
   - Execution traces
   - LLM inputs/outputs
   - Latencies
   - Errors

### LangGraph Studio

```bash
cd ask-clamo
langgraph dev --port 8000
```

Access http://localhost:8000 to:
- Visualize the graph
- Run interactive tests
- Inspect state

## Common Errors

### UNAUTHORIZED (401)

**Symptoms**: API returns 401 on all requests.

**Causes and Solutions**:

```bash
# 1. Expired token - regenerate
# In your app, implement automatic refresh

# 2. Malformed session token
# Verify it's in base64url format
echo $SESSION | base64 -d

# 3. User doesn't exist in Clamo
# Verify in DB
psql $CONTROL_DATABASE_URL -c "SELECT * FROM \"User\" WHERE email = 'user@example.com'"
```

### COMPANY_NOT_READY (422)

**Symptoms**: Cannot access tenant data.

**Diagnosis**:

```sql
SELECT 
  c.id,
  c."databaseStatus",
  cd.status,
  cd."neonBranchId"
FROM "Company" c
LEFT JOIN "CompanyDatabase" cd ON c.id = cd."companyId"
WHERE c.id = 'cmp_xxx';
```

**Solutions**:
1. If `databaseStatus = 'provisioning'`: wait
2. If `databaseStatus = 'failed'`: check clamo-tenant logs
3. Re-provision manually if necessary

### Connection Refused

**Symptoms**: Cannot connect to a service.

**Checklist**:

```bash
# 1. Verify the service is running
docker ps | grep clamo
pgrep -f "clamo-tenant"

# 2. Verify port
lsof -i :4001

# 3. Check logs
docker logs clamo-tenant --tail 50

# 4. Verify environment variables
env | grep DATABASE_URL
```

### Prisma Migration Failed

**Symptoms**: Error when running migrations.

```bash
# 1. View current status
npx prisma migrate status --schema=prisma/control/schema.prisma

# 2. Reset (WARNING: deletes data)
npx prisma migrate reset --schema=prisma/control/schema.prisma

# 3. Force migration
npx prisma migrate resolve --applied "migration_name" --schema=prisma/control/schema.prisma
```

## Monitoring Tools

### Metrics with Prometheus

```bash
# View service metrics
curl http://localhost:4001/metrics

# Useful queries in Grafana
rate(http_requests_total[5m])
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
```

### Tinybird Dashboard

Access https://ui.tinybird.co to:
- View real-time queries
- Monitor data ingestion
- Create visualizations

## Next Steps

<CardGroup cols={2}>
  <Card
    title="Development Environment"
    icon="laptop-code"
    href="/en/getting-started/local-environment"
  >
    Local environment setup.
  </Card>
  <Card
    title="Deployment"
    icon="rocket"
    href="/en/guides/deployment"
  >
    Deployment procedures.
  </Card>
</CardGroup>
