---
title: Autenticación
description: Flujo de autenticación y autorización con WorkOS AuthKit
---

# Autenticación

Clamo utiliza **WorkOS AuthKit** para autenticación y autorización. Este documento explica cómo obtener y usar tokens para acceder a las APIs.

## Flujo de Autenticación

```mermaid
sequenceDiagram
    participant User
    participant App as Tu Aplicación
    participant WorkOS
    participant Clamo as API Clamo

    User->>App: Clic en "Iniciar Sesión"
    App->>WorkOS: Redirect a AuthKit
    WorkOS->>User: Pantalla de login
    User->>WorkOS: Credenciales
    WorkOS->>App: Callback con código
    App->>WorkOS: Intercambiar código por tokens
    WorkOS-->>App: access_token + user_info
    App->>App: Crear sesión Clamo
    App->>Clamo: Request con tokens
    Clamo-->>App: Datos
```

## Tokens Requeridos

Para autenticarte con las APIs de Clamo necesitas:

| Token | Header | Descripción |
|-------|--------|-------------|
| Access Token | `Authorization: Bearer <token>` | Token JWT de WorkOS |

<Note>
**Nota sobre `x-clamo-session`:** Este header es **legacy** y solo se usa en desarrollo local sin Kong. En producción, los servicios backend confían en los headers `x-workos-*` que Kong inyecta después de validar el JWT.
</Note>

### Headers de Kong (Producción)

En producción, Kong API Gateway valida el JWT de WorkOS y añade headers upstream:

| Header | Descripción |
|--------|-------------|
| `x-workos-user-id` | ID del usuario autenticado (extraído del JWT) |
| `x-workos-org-id` | ID de la organización WorkOS |
| `x-workos-role` | Rol del usuario en la organización |
| `x-workos-permissions` | Permisos del usuario |

Los servicios backend confían en estos headers ya que Kong los valida.

## Obtener Access Token

### Con Next.js (AuthKit)

```typescript
import { getSession } from '@workos-inc/authkit-nextjs';

export async function GET(request: Request) {
  const session = await getSession();
  
  if (!session) {
    return Response.json({ error: 'No autenticado' }, { status: 401 });
  }
  
  const { accessToken, user, organizationId } = session;
  
  // Usar accessToken para llamar a Clamo
}
```

### Con el SDK de WorkOS

```typescript
import WorkOS from '@workos-inc/node';

const workos = new WorkOS(process.env.WORKOS_API_KEY);

// Después del callback de OAuth
const { accessToken, refreshToken, user } = await workos.userManagement.authenticateWithCode({
  clientId: process.env.WORKOS_CLIENT_ID,
  code: authCode,
});
```

## Crear Session Token (Legacy - Solo Dev Local)

<Warning>
**Legacy:** El session token solo es necesario para desarrollo local sin Kong. En producción, Kong maneja la autenticación e inyecta los headers `x-workos-*` automáticamente.
</Warning>

Para desarrollo local, el session token es un objeto JSON codificado en base64 que contiene información del usuario:

```typescript
interface ClamoSession {
  userId: string;           // ID de usuario en Clamo
  workosUserId: string;     // ID de usuario en WorkOS
  organizationId: string;   // ID de organización WorkOS
  companyId: string;        // ID de empresa en Clamo
  email: string;
  role: 'admin' | 'member';
}

function createSessionToken(session: ClamoSession): string {
  const json = JSON.stringify(session);
  return Buffer.from(json).toString('base64url');
}
```

### Ejemplo Completo

```typescript
// Después de autenticar con WorkOS
const workosSession = await getSession();

// Obtener información adicional de Clamo
const meResponse = await fetch('https://api.clamo.dev/v1/me', {
  headers: {
    'Authorization': `Bearer ${workosSession.accessToken}`,
  },
});
const clamoUser = await meResponse.json();

// Crear session token
const sessionData = {
  userId: clamoUser.id,
  workosUserId: workosSession.user.id,
  organizationId: workosSession.organizationId,
  companyId: clamoUser.companyId,
  email: clamoUser.email,
  role: clamoUser.role,
};

const sessionToken = Buffer.from(JSON.stringify(sessionData)).toString('base64url');

// Ahora puedes usar ambos tokens
const response = await fetch('https://api.clamo.dev/v1/cases', {
  headers: {
    'Authorization': `Bearer ${workosSession.accessToken}`,
    'x-clamo-session': sessionToken,
  },
});
```

## Ejemplo de Request Autenticada

<CodeGroup>

```javascript JavaScript
const accessToken = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...';

// En producción, solo envía el header Authorization
// Kong validará el JWT e inyectará los headers x-workos-*
const response = await fetch('https://api.clamo.dev/v1/cases', {
  headers: {
    'Authorization': `Bearer ${accessToken}`,
  },
});

const data = await response.json();
```

```python Python
import httpx

access_token = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."

# En producción, solo envía el header Authorization
response = httpx.get(
    "https://api.clamo.dev/v1/cases",
    headers={
        "Authorization": f"Bearer {access_token}",
    }
)
```

```bash cURL
curl -X GET https://api.clamo.dev/v1/cases \
  -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
```

</CodeGroup>

## Refresh Tokens

Los access tokens de WorkOS expiran después de un tiempo. Usa el refresh token para obtener uno nuevo:

```typescript
import WorkOS from '@workos-inc/node';

const workos = new WorkOS(process.env.WORKOS_API_KEY);

const { accessToken, refreshToken } = await workos.userManagement.authenticateWithRefreshToken({
  clientId: process.env.WORKOS_CLIENT_ID,
  refreshToken: storedRefreshToken,
});
```

## Roles y Permisos

Clamo define dos roles principales:

| Rol | Descripción | Permisos |
|-----|-------------|----------|
| `admin` | Administrador de empresa | CRUD completo, invitar usuarios, configuración |
| `member` | Miembro | Lectura de casos, comentarios |

### Verificar Permisos

```typescript
// El rol viene en el session token
const session = JSON.parse(
  Buffer.from(sessionToken, 'base64url').toString()
);

if (session.role !== 'admin') {
  throw new Error('Se requieren permisos de administrador');
}
```

## Errores de Autenticación

| Código | Error | Causa |
|--------|-------|-------|
| 401 | `UNAUTHORIZED` | Token faltante o inválido |
| 401 | `TOKEN_EXPIRED` | Access token expirado |
| 401 | `INVALID_SESSION` | Session token malformado |
| 403 | `FORBIDDEN` | Sin permisos para el recurso |
| 403 | `ORGANIZATION_MISMATCH` | Token de otra organización |

### Ejemplo de Error

```json
{
  "error": {
    "code": "TOKEN_EXPIRED",
    "message": "El access token ha expirado. Por favor, renueva tu sesión.",
    "details": {
      "expiredAt": "2025-01-02T10:00:00Z"
    }
  }
}
```

## Configuración de WorkOS

Para integrar WorkOS en tu aplicación:

1. Crea una cuenta en [WorkOS](https://workos.com)
2. Configura AuthKit con tu dominio
3. Obtén las credenciales:

```bash
WORKOS_API_KEY=sk_live_...
WORKOS_CLIENT_ID=client_...
```

4. Configura el callback URL en el dashboard de WorkOS

## Seguridad

<Warning>
**Nunca expongas tokens en el frontend**

Los access tokens y refresh tokens deben manejarse solo en el backend. Usa cookies HttpOnly para almacenar sesiones en el navegador.
</Warning>

### Mejores Prácticas

- Usa HTTPS siempre
- Almacena refresh tokens de forma segura (encrypted at rest)
- Implementa logout que invalide tokens
- Rota refresh tokens periódicamente
- Valida el `organizationId` en cada request

## Próximos Pasos

<CardGroup cols={2}>
  <Card
    title="Errores"
    icon="triangle-exclamation"
    href="/api-reference/errores"
  >
    Manejo de errores y códigos de respuesta.
  </Card>
  <Card
    title="Guía de Autenticación"
    icon="book"
    href="/guias/autenticacion"
  >
    Guía completa de integración con WorkOS.
  </Card>
</CardGroup>

