---
title: clamo-database
description: Esquemas Prisma, migraciones y gestión de conexiones multi-tenant
---

Paquete compartido con esquemas Prisma, migraciones y utilidades para gestión de conexiones multi-tenant.

## Información General

| Propiedad | Valor |
|-----------|-------|
| **Repositorio** | `GetClamo/clamo-database` |
| **Lenguaje** | TypeScript |
| **ORM** | Prisma |
| **Paquete** | `@getclamo/database` |
| **Bases de Datos** | Supabase (Control) + Neon (Tenants) |

## Arquitectura

```mermaid
flowchart TB
    subgraph Package [@getclamo/database]
        ControlSchema[Control Schema]
        TenantSchema[Tenant Schema]
        ClientFactory[Client Factory]
        LRUCache[LRU Cache]
    end

    subgraph Databases [Bases de Datos]
        Supabase[(Supabase<br/>Control Plane)]
        Neon1[(Neon Tenant 1)]
        Neon2[(Neon Tenant 2)]
        NeonN[(Neon Tenant N)]
    end

    ControlSchema --> Supabase
    TenantSchema --> Neon1
    TenantSchema --> Neon2
    TenantSchema --> NeonN

    ClientFactory --> LRUCache
    LRUCache --> Neon1
    LRUCache --> Neon2
    LRUCache --> NeonN
```

## Esquema Control Plane

```mermaid
erDiagram
    Company ||--o{ User : has
    Company ||--o| CompanyDatabase : has
    Company ||--o{ Company : parent

    Company {
        uuid id PK
        string workosOrgId UK
        string name
        string ruc
        uuid parentId FK
        string plan
        enum databaseStatus
        string billingEmail
        json settings
        json features
    }

    CompanyDatabase {
        uuid id PK
        uuid companyId FK,UK
        string neonProjectId
        string neonBranchId
        string databaseName
        string databaseHost
        string pooledConnSecretId
        string directConnSecretId
    }

    User {
        uuid id PK
        string workosUserId UK
        string email UK
        string firstName
        string lastName
        uuid companyId FK
        string role
        enum onboardingState
    }

    Stage ||--o{ SubStage : has
    SubStage ||--o{ Milestone : has

    Stage {
        string code PK
        string name
        int sortOrder
        boolean isDecision
    }

    SubStage {
        string stageCode PK,FK
        string code PK
        string name
        int sortOrder
    }

    Milestone {
        string stageCode PK,FK
        string subStageCode PK,FK
        string code PK
        string label
        boolean isDecision
    }
```

## Esquema Tenant

```mermaid
erDiagram
    Case ||--o{ Party : has
    Case ||--o{ CaseClaim : has
    Case ||--o{ Movement : has
    Case ||--o{ Decision : has
    Case ||--|| CaseState : has
    Case ||--o{ CaseIngestRun : has

    Case {
        uuid id PK
        string companyId
        string caseNumber
        datetime filingDate
        json subjectMatter
        json processType
        json stage
        string court
        string judge
    }

    Party {
        uuid id PK
        uuid caseId FK
        string name
        enum type
        enum role
    }

    CaseClaim {
        uuid id PK
        uuid caseId FK
        enum claimType
        decimal amount
        string currency
        enum source
    }

    Movement ||--o{ MovementAttachment : has
    Movement ||--o{ MovementNotification : has
    Movement ||--o| Decision : has

    Movement {
        uuid id PK
        uuid caseId FK
        int stablePosition
        datetime cejEventDate
        string cejActo
        string cejResolution
        json name
        json summary
        string stageCode
        string subStageCode
        string milestoneCode
    }

    MovementAttachment {
        uuid id PK
        uuid movementId FK
        string cejNid UK
        string kind
        string url
        enum state
    }

    MovementNotification {
        uuid id PK
        uuid movementId FK
        string destinatario
        datetime fechaEnvio
        string formaEntrega
    }

    Decision {
        uuid id PK
        uuid caseId FK
        uuid movementId FK,UK
        enum scope
        datetime decidedAt
        enum instanceResult
        enum defendantOutcome
        decimal amountPrincipal
    }

    CaseState {
        uuid caseId PK,FK
        uuid lastMovementId
        string currentStageCode
        boolean isArchived
        enum archiveType
        enum finalStatus
        enum defendantOutcome
    }

    CaseIngestRun {
        uuid id PK
        uuid caseId FK
        string expediente
        string manifestHash
        enum status
    }

    Dashboard {
        uuid id PK
        string companyId
        string name
        json config
        boolean isDefault
    }
```

## Uso

```typescript
import { controlDb, createTenantPrisma } from "@getclamo/database";

// Cliente control plane (singleton)
const companies = await controlDb.company.findMany();

// Cliente tenant (cacheado por conexión)
const tenantDb = createTenantPrisma(connectionString);
const cases = await tenantDb.case.findMany();
```

## Configuración

### Variables de Entorno

```bash
# Base de datos de control
CONTROL_DATABASE_URL=postgresql://...

# Supabase (para Vault)
SUPABASE_URL=https://...
SUPABASE_SERVICE_KEY=...

# Para desarrollo local con tenant específico
TENANT_DATABASE_URL=postgresql://...
```

## Desarrollo Local

```bash
# Instalar dependencias
pnpm install

# Generar clientes Prisma
pnpm db:generate

# Ejecutar migraciones de control
pnpm migrate:control

# Ejecutar migraciones de tenants (todos)
pnpm migrate:tenants

# Build del paquete
pnpm build
```

## Próximos Pasos

<CardGroup cols={2}>
  <Card
    title="Entidades"
    icon="database"
    href="/es/entidades/index"
  >
    Referencia completa de entidades.
  </Card>
  <Card
    title="Multi-Tenancy"
    icon="building"
    href="/es/guias/multi-tenancy"
  >
    Arquitectura multi-tenant.
  </Card>
</CardGroup>
