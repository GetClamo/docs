---
title: Operaciones de Base de Datos
description: Scripts de migraciÃ³n, dry-run y gestiÃ³n de bases de datos multi-tenant
---

# Operaciones de Base de Datos

Esta guÃ­a documenta los scripts y procedimientos para gestionar las bases de datos de Clamo, incluyendo migraciones masivas de tenants y el concepto de Dry Run.

## Arquitectura de Datos: Control Plane vs Tenant Data Plane

Clamo implementa una separaciÃ³n estricta entre dos planos de datos:

```mermaid
flowchart TB
    subgraph ControlPlane [Control Plane - Supabase]
        ControlDB[(Control Database)]
        Vault[Supabase Vault<br/>Secrets Storage]
        
        subgraph ControlTables [Tablas de Control]
            Company[Company]
            User[User]
            CompanyDatabase[CompanyDatabase]
        end
    end
    
    subgraph TenantPlane [Tenant Data Plane - Neon]
        subgraph Tenant1 [Tenant A Branch]
            Cases1[Case]
            Movements1[Movement]
            Entities1[MonitoredEntity]
            IngestRuns1[CaseIngestRun]
        end
        
        subgraph Tenant2 [Tenant B Branch]
            Cases2[Case]
            Movements2[Movement]
            Entities2[MonitoredEntity]
            IngestRuns2[CaseIngestRun]
        end
    end
    
    ControlDB --> Company
    ControlDB --> User
    ControlDB --> CompanyDatabase
    
    CompanyDatabase -->|pooledConnSecretId| Vault
    Vault -->|connectionString| Tenant1
    Vault -->|connectionString| Tenant2
```

### Control Plane (Supabase)

El plano de control almacena informaciÃ³n **global de la plataforma**:

| Tabla | DescripciÃ³n |
|-------|-------------|
| `Company` | Empresas registradas, plan, estado de onboarding |
| `User` | Usuarios de todas las empresas, roles |
| `CompanyDatabase` | Metadata de conexiÃ³n a bases de datos de tenant |

**CaracterÃ­sticas:**
- Base de datos Ãºnica en Supabase
- Contiene referencias a secretos en Vault (no credenciales en texto plano)
- Esquema definido en `prisma/control/schema.prisma`

### Tenant Data Plane (Neon)

El plano de datos de tenant almacena **datos especÃ­ficos de cada empresa**:

| Tabla | DescripciÃ³n |
|-------|-------------|
| `MonitoredEntity` | Entidades (RUCs) monitoreadas |
| `Case` | Expedientes judiciales |
| `Movement` | Movimientos procesales |
| `CaseProgress` | Historial de etapas |
| `CaseMilestone` | Hitos alcanzados |
| `CaseIngestRun` | Trazabilidad de ingesta |

**CaracterÃ­sticas:**
- Una base de datos (branch de Neon) por tenant
- Aislamiento completo de datos entre empresas
- Esquema definido en `prisma/tenant/schema.prisma`

## ResoluciÃ³n de Conexiones

El sistema usa `@getclamo/tenant-sdk` para obtener connection strings de forma segura:

```typescript
import { TenantClient } from "@getclamo/tenant-sdk";

const tenant = new TenantClient({
  baseUrl: process.env.TENANT_SERVICE_URL,
});

// Obtener connection string para un tenant
const { connectionString } = await tenant.internal.getDatabaseConnection(companyId);
```

### Flujo de ResoluciÃ³n

```mermaid
sequenceDiagram
    participant Service as Servicio Backend
    participant TenantAPI as clamo-tenant
    participant ControlDB as Control DB
    participant Vault as Supabase Vault
    
    Service->>TenantAPI: GET /internal/v1/companies/:id/database-connection
    TenantAPI->>ControlDB: SELECT * FROM CompanyDatabase WHERE companyId = :id
    ControlDB-->>TenantAPI: { pooledConnSecretId: "secret_xxx" }
    TenantAPI->>Vault: vault.decrypted_secrets WHERE name = "secret_xxx"
    Vault-->>TenantAPI: connectionString
    TenantAPI-->>Service: { connectionString: "postgresql://..." }
```

### Cache de Conexiones

`clamo-database` implementa un pool de conexiones para optimizar el rendimiento:

```typescript
import { TenantConnectionPool } from '@getclamo/database';

const pool = new TenantConnectionPool({
  maxConnections: 10,
  idleTimeout: 30000,  // 30 segundos
});

// Obtiene conexiÃ³n del cache o crea una nueva
const tenantDb = await pool.getConnection(companyId);
```

### InvalidaciÃ³n de Cache

<Warning>
**Importante:** Si cambias una connection string en Vault (ej. rotaciÃ³n de credenciales), los servicios **no se enteran automÃ¡ticamente**. El cache tiene un TTL de 5 minutos por defecto.
</Warning>

**Opciones para invalidar el cache:**

1. **Esperar el TTL** (5 minutos) - Las conexiones inactivas se limpian automÃ¡ticamente.

2. **Reiniciar el servicio** - Fuerza la recarga de todas las conexiones.
   ```bash
   # En Kubernetes
   kubectl rollout restart deployment clamo-cases -n clamo
   ```

3. **Llamar al endpoint de health con force-refresh** (si estÃ¡ implementado):
   ```bash
   curl -X POST http://cases.internal:4000/internal/health/refresh-connections
   ```

**ConfiguraciÃ³n del cache:**

| Variable | Default | DescripciÃ³n |
|----------|---------|-------------|
| `TENANT_POOL_MAX_CONNECTIONS` | 10 | MÃ¡ximo de conexiones por tenant |
| `TENANT_POOL_IDLE_TIMEOUT` | 30000 | Timeout de inactividad (ms) |
| `TENANT_POOL_TTL` | 300000 | TTL del cache (5 min) |

## Scripts de MigraciÃ³n

Los scripts de migraciÃ³n estÃ¡n en `clamo-database/scripts/`:

```
clamo-database/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ migrate-tenants.ts    # MigraciÃ³n masiva de tenants
â”‚   â”œâ”€â”€ migrate-dry-run.ts    # Dry run con contenedores efÃ­meros
â”‚   â”œâ”€â”€ migrate-control.ts    # MigraciÃ³n del control plane
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ shared.ts         # Utilidades compartidas
```

### migrate:tenants - MigraciÃ³n Masiva de Tenants

Este script ejecuta migraciones de Prisma en todas las bases de datos de tenant.

#### Uso BÃ¡sico

```bash
# Migrar todos los tenants en staging
pnpm migrate:tenants stg

# Migrar todos los tenants en producciÃ³n
pnpm migrate:tenants prd

# Migrar un tenant especÃ­fico
pnpm migrate:tenants prd --company-id <uuid>

# Preview sin ejecutar (dry run)
pnpm migrate:tenants prd --dry-run
```

#### Estrategias de ConexiÃ³n

El script soporta dos estrategias para obtener connection strings:

**1. Via API (default para stg/prd):**
```bash
pnpm migrate:tenants prd --via api
```
- Llama al endpoint interno de clamo-tenant
- Requiere acceso Tailscale al servicio
- Recomendado para uso normal

**2. Via Vault (acceso directo):**
```bash
pnpm migrate:tenants prd --via vault
```
- Consulta CompanyDatabase y obtiene secretos de Vault directamente
- NO requiere que clamo-tenant estÃ© corriendo
- Ãštil para emergencias o mantenimiento

#### Reglas de Seguridad

El script implementa varias reglas de seguridad:

1. **Solo migra empresas con `databaseStatus=READY`**
2. **Salta el branch template** (schema-only, sin datos)
3. **Solo migra DBs asociadas con empresas en control plane**

```typescript
const targets = companies
  .filter((c) => c.databaseStatus === "READY")
  .filter((c) => c.Database !== null)
  .filter((c) => c.Database?.neonBranchId !== BRANCH_TEMPLATE_ID);
```

#### Ejemplo de Output

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Tenant Migration: PRD
  Strategy: API
  Dry Run: false
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š Found 45 companies to migrate (databaseStatus=READY)

ğŸ”— Tenant Service: https://tenant.prd.clamo.services

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¦ Empresa ABC S.A.C.
   ID: cmp_abc123
   Branch: br-xyz-456
  ğŸš€ Running migrations...
  âœ… Migration complete

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¦ Empresa XYZ S.A.
   ID: cmp_xyz789
   Branch: br-abc-123
  ğŸš€ Running migrations...
  âœ… Migration complete

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Summary
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… Migrated: 45
  â­ï¸  Skipped:  0
  âŒ Failed:   0
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### Concepto de Dry Run

El **Dry Run** permite probar migraciones contra una copia del esquema de producciÃ³n **sin tocar datos reales**.

#### Â¿CÃ³mo Funciona?

```mermaid
flowchart LR
    subgraph Production [ProducciÃ³n]
        ProdDB[(Production DB)]
    end
    
    subgraph DryRun [Dry Run]
        Docker[Docker Container<br/>PostgreSQL EfÃ­mero]
        Schema[Schema Copy<br/>pg_dump --schema-only]
    end
    
    subgraph Test [Test]
        Migration[prisma migrate deploy]
        Result{Â¿Ã‰xito?}
    end
    
    ProdDB -->|pg_dump| Schema
    Schema -->|psql| Docker
    Docker --> Migration
    Migration --> Result
    Result -->|SÃ­| Safe[âœ… Safe to deploy]
    Result -->|No| Fix[âŒ Fix migrations]
```

#### Uso del Dry Run

```bash
# Test both control & tenant planes
pnpm dry-run prd

# Test only control plane
pnpm dry-run prd --plane control

# Test only tenant plane
pnpm dry-run prd --plane tenant

# Test specific tenant
pnpm dry-run prd --company-id <uuid>

# Use vault strategy
pnpm dry-run prd --via vault
```

#### Ejemplo de Output

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ğŸ§ª DRY-RUN DATABASE MIGRATIONS (Ephemeral)              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Environment:   PRD                                                  â•‘
â•‘  Planes:        CONTROL + TENANT                                     â•‘
â•‘  Strategy:      VAULT                                                â•‘
â•‘  Tenant scope:  ALL (using template)                                 â•‘
â•‘  Timeout:       20 minutes                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“‹ CONTROL PLANE (Supabase)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ³ Starting ephemeral container: dry-run-control-1705234567
    âœ… Container ready
    ğŸ“¥ Dumping schema from production control...
    ğŸ“¤ Restoring to ephemeral container...
    ğŸš€ Running control migrations...
    âœ… Control migrations would apply cleanly

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ“‹ TENANT PLANE (Neon)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ” Using template branch from PRD_TENANT_DATABASE_URL
    âœ… Source: template branch (from env)
    ğŸ³ Starting ephemeral container: dry-run-tenant-1705234567
    âœ… Container ready
    ğŸ“¥ Dumping schema from template branch...
    ğŸ“¤ Restoring to ephemeral container...
    ğŸš€ Running tenant migrations...
    âœ… Tenant migrations would apply cleanly

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  âœ… DRY-RUN SUCCESSFUL - All migrations would apply cleanly
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

To apply migrations for real:

  pnpm migrate:control prd
  pnpm migrate:tenants prd --via vault
```

### migrate:control - MigraciÃ³n del Control Plane

```bash
# Migrar control plane en staging
pnpm migrate:control stg

# Migrar control plane en producciÃ³n
pnpm migrate:control prd
```

## Variables de Entorno Requeridas

```bash
# Control database (Supabase)
CONTROL_DATABASE_URL=postgresql://user:pass@host:5432/control?sslmode=require

# Para producciÃ³n (alternativa)
PRD_CONTROL_DATABASE_URL=postgresql://...

# Tenant service URL (para --via api)
TENANT_SERVICE_URL=https://tenant.prd.clamo.services
# O por ambiente
TENANT_SERVICE_URL_STG=https://tenant.stg.clamo.dev
TENANT_SERVICE_URL_PRD=https://tenant.prd.clamo.services

# Branch template ID (para dry-run)
PRD_TENANT_BRANCH_TEMPLATE_ID=br-xxx-yyy

# Tenant database URL (alternativa para dry-run)
PRD_TENANT_DATABASE_URL=postgresql://...
```

## Crear Nueva MigraciÃ³n

### Para el Esquema de Control

```bash
cd clamo-database

# Crear migraciÃ³n
npx prisma migrate dev --schema=prisma/control/schema.prisma --name add_new_field

# Generar cliente
pnpm db:generate
```

### Para el Esquema de Tenant

```bash
cd clamo-database

# Crear migraciÃ³n
npx prisma migrate dev --schema=prisma/tenant/schema.prisma --name add_new_field

# Generar cliente
pnpm db:generate
```

## Flujo de Trabajo Recomendado

```mermaid
flowchart TD
    A[Crear migraciÃ³n local] --> B[Test local con docker]
    B --> C[Commit & Push]
    C --> D[Dry Run en STG]
    D --> E{Â¿Ã‰xito?}
    E -->|No| F[Fix migration]
    F --> A
    E -->|SÃ­| G[Deploy a STG]
    G --> H[Migrate STG tenants]
    H --> I[Verificar STG]
    I --> J[Dry Run en PRD]
    J --> K{Â¿Ã‰xito?}
    K -->|No| F
    K -->|SÃ­| L[Deploy a PRD]
    L --> M[Migrate PRD tenants]
```

### Comandos del Flujo

```bash
# 1. Desarrollo local
cd clamo-database
npx prisma migrate dev --schema=prisma/tenant/schema.prisma --name my_migration

# 2. Test local
pnpm migrate:tenants local

# 3. Dry run en staging
pnpm dry-run stg

# 4. Migrar staging
pnpm migrate:tenants stg

# 5. Dry run en producciÃ³n
pnpm dry-run prd

# 6. Migrar producciÃ³n
pnpm migrate:tenants prd
```

## Troubleshooting

### Error: "Company not found in tenant service"

```bash
# Verificar que la empresa existe y tiene databaseStatus=READY
psql $CONTROL_DATABASE_URL -c "
  SELECT id, name, \"databaseStatus\" 
  FROM \"Company\" 
  WHERE id = 'cmp_xxx'
"
```

### Error: "Secret not found in vault"

```bash
# Verificar que el secreto existe
psql $CONTROL_DATABASE_URL -c "
  SELECT cd.\"pooledConnSecretId\"
  FROM \"CompanyDatabase\" cd
  WHERE cd.\"companyId\" = 'cmp_xxx'
"

# Verificar en vault
psql $CONTROL_DATABASE_URL -c "
  SELECT name FROM vault.decrypted_secrets 
  WHERE name LIKE 'tenant-%'
"
```

### Error: "Migration failed"

```bash
# Ver estado de migraciones
DATABASE_URL="postgresql://..." npx prisma migrate status --schema=prisma/tenant/schema.prisma

# Forzar resoluciÃ³n (CUIDADO)
DATABASE_URL="postgresql://..." npx prisma migrate resolve --applied "migration_name" --schema=prisma/tenant/schema.prisma
```

## DocumentaciÃ³n Relacionada

<CardGroup cols={2}>
  <Card
    title="Multi-Tenancy"
    icon="building"
    href="/es/guias/multi-tenancy"
  >
    Arquitectura multi-tenant completa.
  </Card>
  <Card
    title="clamo-database"
    icon="database"
    href="/es/servicios/clamo-database"
  >
    DocumentaciÃ³n del paquete de base de datos.
  </Card>
  <Card
    title="clamo-tenant"
    icon="server"
    href="/es/servicios/clamo-tenant"
  >
    Servicio de gestiÃ³n de tenants.
  </Card>
  <Card
    title="DepuraciÃ³n"
    icon="bug"
    href="/es/guias/depuracion"
  >
    GuÃ­a general de troubleshooting.
  </Card>
</CardGroup>
