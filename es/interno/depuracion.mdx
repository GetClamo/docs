---
title: Depuración
description: Guía de troubleshooting y depuración para servicios de Clamo
---

# Guía de Depuración

Esta guía proporciona técnicas y herramientas para depurar los diferentes servicios de Clamo.

## Logs por Servicio

### Ubicaciones de Logs

| Servicio | Ubicación | Formato |
|----------|-----------|---------|
| clamo-web-app | Terminal / Browser Console | JSON |
| clamo-tenant | Terminal stdout | JSON |
| clamo-cases | Terminal stdout | JSON |
| clamo-cej-connector | Docker logs / Temporal UI | JSON |
| clamo-ingest-go | Docker logs | Structured |
| Temporal | http://localhost:8233 | Web UI |

### Ver Logs en Tiempo Real

```bash
# Servicios TypeScript (desarrollo)
cd clamo-tenant && pnpm dev

# Servicios Docker
docker logs -f clamo-cej-connector

# Todos los servicios Docker
docker-compose logs -f

# Filtrar por nivel
docker logs clamo-cej-connector 2>&1 | grep ERROR
```

## Depuración de Base de Datos

### Prisma Studio

```bash
# Control database
cd clamo-database
npx prisma studio --schema=prisma/control/schema.prisma

# Tenant database (requiere connection string)
DATABASE_URL="postgresql://..." npx prisma studio --schema=prisma/tenant/schema.prisma
```

### Queries Directas con psql

```bash
# Conectar a control DB
psql $CONTROL_DATABASE_URL

# Queries útiles
SELECT * FROM "Company" ORDER BY "createdAt" DESC LIMIT 10;
SELECT * FROM "User" WHERE "companyId" = 'cmp_xxx';
SELECT * FROM "CompanyDatabase" WHERE status = 'active';
```

### Verificar Estado de Tenant

```sql
-- Ver todas las empresas y su estado de DB
SELECT 
  c.id,
  c.name,
  c."databaseStatus",
  cd.status as db_status,
  cd."neonBranchId"
FROM "Company" c
LEFT JOIN "CompanyDatabase" cd ON c.id = cd."companyId"
ORDER BY c."createdAt" DESC;
```

## Depuración de APIs

### Postman Collection

Importa la colección de Postman desde:
```
clamo-commons/postman/Clamo-API.postman_collection.json
```

### cURL Examples

```bash
# Health check
curl http://localhost:4001/health | jq

# Obtener usuario actual
curl http://localhost:4001/v1/me \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" | jq

# Listar casos
curl "http://localhost:4000/v1/cases?limit=5" \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" | jq
```

### Generar Session Token para Testing

```typescript
// scripts/generate-session.ts
import { encode } from 'base64url';

const session = {
  userId: 'usr_test123',
  workosUserId: 'user_workos123',
  organizationId: 'org_test456',
  companyId: 'cmp_test789',
  email: 'test@example.com',
  role: 'admin',
};

console.log(encode(JSON.stringify(session)));
```

## Depuración de Temporal Workflows

### Temporal Web UI

Accede a http://localhost:8233 para:
- Ver workflows en ejecución
- Inspeccionar historial de eventos
- Reiniciar workflows fallidos
- Ver métricas

### CLI de Temporal

```bash
# Listar workflows
temporal workflow list --namespace clamo-cej

# Ver detalle de workflow
temporal workflow show --workflow-id extract-ruc-20123456789

# Terminar workflow
temporal workflow terminate --workflow-id extract-ruc-20123456789

# Ver historial
temporal workflow show --workflow-id extract-ruc-20123456789 --output json | jq
```

## Depuración de Kafka

### Kafka UI

Si usas Docker Compose, accede a http://localhost:8080 (Kafka UI).

### CLI de Kafka

```bash
# Listar topics
kafka-topics.sh --bootstrap-server localhost:9092 --list

# Consumir mensajes
kafka-console-consumer.sh \
  --bootstrap-server localhost:9092 \
  --topic cej.case.ready \
  --from-beginning

# Ver offsets de consumer group
kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --group clamo-ingest \
  --describe
```

## Depuración de Agentes IA

### LangSmith Integration

1. Configura las variables de entorno:
```bash
LANGCHAIN_TRACING_V2=true
LANGCHAIN_API_KEY=ls__...
LANGCHAIN_PROJECT=clamo-dev
```

2. Accede a https://smith.langchain.com para ver:
   - Traces de ejecución
   - Inputs/outputs de LLM
   - Latencias
   - Errores

### LangGraph Studio

```bash
cd ask-clamo
langgraph dev --port 8123
```

Accede a http://localhost:8123 para:
- Visualizar el grafo
- Ejecutar pruebas interactivas
- Inspeccionar estado

## Errores Comunes

### UNAUTHORIZED (401)

**Síntomas**: API retorna 401 en todas las requests.

**Causas y Soluciones**:

```bash
# 1. Token expirado - regenerar
# En tu app, implementa refresh automático

# 2. Session token malformado
# Verificar que esté en base64url
echo $SESSION | base64 -d

# 3. Usuario no existe en Clamo
# Verificar en DB
psql $CONTROL_DATABASE_URL -c "SELECT * FROM \"User\" WHERE email = 'user@example.com'"
```

### COMPANY_NOT_READY (422)

**Síntomas**: No se puede acceder a datos del tenant.

**Diagnóstico**:

```sql
SELECT 
  c.id,
  c."databaseStatus",
  cd.status,
  cd."neonBranchId"
FROM "Company" c
LEFT JOIN "CompanyDatabase" cd ON c.id = cd."companyId"
WHERE c.id = 'cmp_xxx';
```

**Soluciones**:
1. Si `databaseStatus = 'provisioning'`: esperar
2. Si `databaseStatus = 'failed'`: revisar logs de clamo-tenant
3. Re-provisionar manualmente si es necesario

### Connection Refused

**Síntomas**: No se puede conectar a un servicio.

**Checklist**:

```bash
# 1. Verificar que el servicio está corriendo
docker ps | grep clamo
pgrep -f "clamo-tenant"

# 2. Verificar puerto
lsof -i :4001

# 3. Verificar logs
docker logs clamo-tenant --tail 50

# 4. Verificar variables de entorno
env | grep DATABASE_URL
```

### Prisma Migration Failed

**Síntomas**: Error al ejecutar migraciones.

```bash
# 1. Ver estado actual
npx prisma migrate status --schema=prisma/control/schema.prisma

# 2. Reset (CUIDADO: borra datos)
npx prisma migrate reset --schema=prisma/control/schema.prisma

# 3. Forzar migración
npx prisma migrate resolve --applied "migration_name" --schema=prisma/control/schema.prisma
```

## Herramientas de Monitoreo

### Métricas con Prometheus

```bash
# Ver métricas de un servicio
curl http://localhost:4001/metrics

# Queries útiles en Grafana
rate(http_requests_total[5m])
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
```

### Tinybird Dashboard

Accede a https://ui.tinybird.co para:
- Ver queries en tiempo real
- Monitorear ingesta de datos
- Crear visualizaciones

## Próximos Pasos

<CardGroup cols={2}>
  <Card
    title="Entorno de Desarrollo"
    icon="laptop-code"
    href="/es/interno/entorno-desarrollo"
  >
    Configuración del entorno local.
  </Card>
  <Card
    title="Despliegue"
    icon="rocket"
    href="/es/interno/despliegue"
  >
    Procedimientos de deployment.
  </Card>
</CardGroup>

