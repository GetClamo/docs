---
title: Webhooks
description: Recibe notificaciones en tiempo real de eventos en Clamo
---

# Webhooks

Los webhooks permiten que tu aplicación reciba notificaciones cuando ocurren eventos importantes en Clamo.

## Eventos Disponibles

| Evento | Descripción |
|--------|-------------|
| `case.created` | Nuevo caso detectado |
| `case.updated` | Caso actualizado |
| `case.status_changed` | Cambio de estado del caso |
| `movement.created` | Nuevo movimiento procesal |
| `movement.notification` | Movimiento con notificación |
| `milestone.achieved` | Hito procesal alcanzado |
| `risk.elevated` | Nivel de riesgo aumentado |

## Configuración

### Registrar Webhook

```bash
curl -X POST https://api.clamo.dev/v1/webhooks \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://tu-app.com/webhooks/clamo",
    "events": ["case.created", "movement.created", "risk.elevated"],
    "secret": "whsec_tu_secreto_seguro"
  }'
```

### Respuesta

```json
{
  "id": "wh_abc123",
  "url": "https://tu-app.com/webhooks/clamo",
  "events": ["case.created", "movement.created", "risk.elevated"],
  "status": "active",
  "createdAt": "2025-01-02T12:00:00Z"
}
```

## Formato del Payload

Todos los webhooks siguen este formato:

```json
{
  "id": "evt_xyz789",
  "type": "movement.created",
  "timestamp": "2025-01-02T12:00:00Z",
  "data": {
    // Datos específicos del evento
  },
  "metadata": {
    "companyId": "cmp_abc123",
    "webhookId": "wh_abc123"
  }
}
```

## Ejemplos de Eventos

### case.created

```json
{
  "id": "evt_001",
  "type": "case.created",
  "timestamp": "2025-01-02T12:00:00Z",
  "data": {
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01",
      "plaintiff": "Juan Pérez",
      "defendant": "Empresa S.A.C.",
      "subjectMatter": "Despido arbitrario",
      "riskLevel": "MEDIUM",
      "status": "EN_TRAMITE",
      "filingDate": "2024-01-15"
    },
    "monitoredEntity": {
      "id": "ent_xyz",
      "ruc": "20123456789",
      "name": "Empresa S.A.C."
    }
  }
}
```

### movement.created

```json
{
  "id": "evt_002",
  "type": "movement.created",
  "timestamp": "2025-01-02T14:30:00Z",
  "data": {
    "movement": {
      "id": "mov_xyz789",
      "date": "2025-01-02",
      "description": "RESOLUCIÓN N° 15: Se tiene por contestada la demanda",
      "classification": "RESOLUCION",
      "isNotification": false,
      "summary": "El juzgado admite la contestación de demanda presentada por la empresa."
    },
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01"
    }
  }
}
```

### risk.elevated

```json
{
  "id": "evt_003",
  "type": "risk.elevated",
  "timestamp": "2025-01-02T16:00:00Z",
  "data": {
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01"
    },
    "previousRiskLevel": "MEDIUM",
    "newRiskLevel": "HIGH",
    "reason": "Sentencia desfavorable en primera instancia",
    "triggerMovement": {
      "id": "mov_def456",
      "description": "SENTENCIA: Se declara FUNDADA la demanda..."
    }
  }
}
```

### milestone.achieved

```json
{
  "id": "evt_004",
  "type": "milestone.achieved",
  "timestamp": "2025-01-02T10:00:00Z",
  "data": {
    "milestone": {
      "code": "SENTENCIA_PRIMERA_INSTANCIA",
      "name": "Sentencia de Primera Instancia",
      "achievedAt": "2025-01-02T10:00:00Z"
    },
    "case": {
      "id": "case_abc123",
      "expediente": "00001-2024-0-1234-JR-LA-01"
    }
  }
}
```

## Verificación de Firma

Clamo firma todos los webhooks con HMAC-SHA256. Verifica la firma antes de procesar:

### Header de Firma

```
X-Clamo-Signature: sha256=abc123...
X-Clamo-Timestamp: 1704200000
```

### Verificación en Node.js

```typescript
import crypto from 'crypto';

function verifyWebhookSignature(
  payload: string,
  signature: string,
  timestamp: string,
  secret: string
): boolean {
  // Verificar que el timestamp no sea muy antiguo (previene replay attacks)
  const timestampMs = parseInt(timestamp) * 1000;
  const now = Date.now();
  if (now - timestampMs > 5 * 60 * 1000) { // 5 minutos
    return false;
  }
  
  // Calcular firma esperada
  const signedPayload = `${timestamp}.${payload}`;
  const expectedSignature = crypto
    .createHmac('sha256', secret)
    .update(signedPayload)
    .digest('hex');
  
  // Comparación segura
  const providedSig = signature.replace('sha256=', '');
  return crypto.timingSafeEqual(
    Buffer.from(expectedSignature),
    Buffer.from(providedSig)
  );
}
```

### Verificación en Python

```python
import hmac
import hashlib
import time

def verify_webhook_signature(
    payload: str,
    signature: str,
    timestamp: str,
    secret: str
) -> bool:
    # Verificar timestamp
    timestamp_int = int(timestamp)
    now = int(time.time())
    if now - timestamp_int > 300:  # 5 minutos
        return False
    
    # Calcular firma esperada
    signed_payload = f"{timestamp}.{payload}"
    expected_signature = hmac.new(
        secret.encode(),
        signed_payload.encode(),
        hashlib.sha256
    ).hexdigest()
    
    # Comparación segura
    provided_sig = signature.replace("sha256=", "")
    return hmac.compare_digest(expected_signature, provided_sig)
```

## Implementación del Endpoint

### Next.js API Route

```typescript
// app/api/webhooks/clamo/route.ts
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';

const WEBHOOK_SECRET = process.env.CLAMO_WEBHOOK_SECRET!;

export async function POST(request: NextRequest) {
  const payload = await request.text();
  const signature = request.headers.get('X-Clamo-Signature')!;
  const timestamp = request.headers.get('X-Clamo-Timestamp')!;
  
  // Verificar firma
  if (!verifyWebhookSignature(payload, signature, timestamp, WEBHOOK_SECRET)) {
    return NextResponse.json(
      { error: 'Invalid signature' },
      { status: 401 }
    );
  }
  
  const event = JSON.parse(payload);
  
  // Procesar evento
  switch (event.type) {
    case 'case.created':
      await handleNewCase(event.data);
      break;
    case 'movement.created':
      await handleNewMovement(event.data);
      break;
    case 'risk.elevated':
      await handleRiskElevation(event.data);
      break;
    default:
      console.log(`Unhandled event type: ${event.type}`);
  }
  
  // Responder 200 para confirmar recepción
  return NextResponse.json({ received: true });
}

async function handleNewCase(data: any) {
  // Notificar al equipo
  await sendSlackNotification({
    channel: '#casos-nuevos',
    text: `Nuevo caso detectado: ${data.case.expediente}`,
  });
}

async function handleNewMovement(data: any) {
  // Actualizar dashboard
  await refreshDashboard(data.case.id);
}

async function handleRiskElevation(data: any) {
  // Alerta urgente
  await sendUrgentAlert({
    case: data.case,
    newRisk: data.newRiskLevel,
    reason: data.reason,
  });
}
```

### Express.js

```typescript
import express from 'express';
import crypto from 'crypto';

const app = express();

// Importante: usar raw body para verificar firma
app.post('/webhooks/clamo', 
  express.raw({ type: 'application/json' }),
  async (req, res) => {
    const payload = req.body.toString();
    const signature = req.headers['x-clamo-signature'] as string;
    const timestamp = req.headers['x-clamo-timestamp'] as string;
    
    if (!verifyWebhookSignature(payload, signature, timestamp, WEBHOOK_SECRET)) {
      return res.status(401).json({ error: 'Invalid signature' });
    }
    
    const event = JSON.parse(payload);
    
    // Procesar en background para responder rápido
    processWebhookAsync(event);
    
    res.json({ received: true });
  }
);
```

## Reintentos

Clamo reintenta webhooks fallidos con backoff exponencial:

| Intento | Delay |
|---------|-------|
| 1 | Inmediato |
| 2 | 1 minuto |
| 3 | 5 minutos |
| 4 | 30 minutos |
| 5 | 2 horas |

Un webhook se considera fallido si:
- Responde con código >= 400
- No responde en 30 segundos
- Hay error de conexión

## Gestión de Webhooks

### Listar Webhooks

```bash
curl -X GET https://api.clamo.dev/v1/webhooks \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION"
```

### Actualizar Webhook

```bash
curl -X PATCH https://api.clamo.dev/v1/webhooks/wh_abc123 \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION" \
  -H "Content-Type: application/json" \
  -d '{
    "events": ["case.created", "movement.created"],
    "status": "active"
  }'
```

### Eliminar Webhook

```bash
curl -X DELETE https://api.clamo.dev/v1/webhooks/wh_abc123 \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION"
```

### Ver Historial de Entregas

```bash
curl -X GET https://api.clamo.dev/v1/webhooks/wh_abc123/deliveries \
  -H "Authorization: Bearer $TOKEN" \
  -H "x-clamo-session: $SESSION"
```

## Mejores Prácticas

<Warning>
**Idempotencia**: Tu endpoint debe ser idempotente. Clamo puede enviar el mismo evento más de una vez en caso de reintentos. Usa el `id` del evento para detectar duplicados.
</Warning>

### Procesamiento Asíncrono

```typescript
// Responder rápido y procesar en background
app.post('/webhooks/clamo', async (req, res) => {
  // Verificar firma...
  
  // Encolar para procesamiento
  await queue.add('process-webhook', event);
  
  // Responder inmediatamente
  res.json({ received: true });
});
```

### Logging

```typescript
async function processWebhook(event: WebhookEvent) {
  console.log(`Processing webhook: ${event.id} (${event.type})`);
  
  try {
    // Procesar...
    console.log(`Webhook processed successfully: ${event.id}`);
  } catch (error) {
    console.error(`Webhook processing failed: ${event.id}`, error);
    throw error; // Para reintentar
  }
}
```

## Próximos Pasos

<CardGroup cols={2}>
  <Card
    title="Errores"
    icon="triangle-exclamation"
    href="/guias/errores"
  >
    Manejo de errores comunes.
  </Card>
  <Card
    title="Mejores Prácticas"
    icon="lightbulb"
    href="/guias/mejores-practicas"
  >
    Recomendaciones de integración.
  </Card>
</CardGroup>

